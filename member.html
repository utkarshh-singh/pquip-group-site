<!DOCTYPE html>
<html lang="en">
<head>
  <title>Member — PQuIP Group</title>
  <!-- Global head (meta/fonts/styles.css) is injected from partials/head.html -->
  <!-- Page-specific CSS: -->
  <link rel="stylesheet" href="assets/css/member.css" />
</head>
<body>
  <div id="site-header"></div>

  <main class="container main-content">
    <article id="member-article" class="profile"></article>
  </main>

  <div id="site-footer"></div>
  <script src="assets/js/main.js"></script>
  <script>
    /* Small inline icons */
    const ICONS = {
      orcid: () => `
        <svg viewBox="0 0 256 256" aria-hidden="true">
          <circle cx="128" cy="128" r="120" />
          <path fill="#fff" d="M86 88h20v80H86zM96 64a12 12 0 110 24 12 12 0 010-24zm42 24c35 0 54 24 54 60 0 38-21 60-56 60h-26V88h28zm-8 104h6c24 0 36-16 36-44s-12-44-36-44h-6v88z"/>
        </svg>`,
      email: () => `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor">
          <rect x="3" y="5" width="18" height="14" rx="2" ry="2"></rect>
          <polyline points="3,7 12,13 21,7"></polyline>
        </svg>`,
      external: () => `
        <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor">
          <path d="M14 3h7v7"></path>
          <path d="M21 3l-9 9"></path>
          <path d="M10 7H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-5"></path>
        </svg>`
    };

    function qs(name){
      try { return new URL(window.location.href).searchParams.get(name); }
      catch { return null; }
    }

    async function fetchSemanticScholarWorks(authorId, limit=8){
      const fields = [
        'name','url',
        'papers.title','papers.year','papers.externalIds',
        'papers.authors','papers.venue','papers.url'
      ].join(',');
      const endpoint = `https://api.semanticscholar.org/graph/v1/author/${encodeURIComponent(authorId)}?fields=${fields}`;
      const res = await fetch(endpoint);
      if(!res.ok) throw new Error('Semantic Scholar fetch failed');
      const json = await res.json();
      const papers = (json.papers || []).sort((a,b)=>(b.year||0)-(a.year||0)).slice(0,limit);
      return papers;
    }

    function chip(html, href=null, extraClass=''){
      const cls = `chip ${extraClass}`.trim();
      return href ? `<a class="${cls}" href="${href}" target="_blank" rel="noopener">${html}${ICONS.external()}</a>`
                  : `<span class="${cls}">${html}</span>`;
    }

    function renderPubs(papers){
      if(!papers?.length) return '<p class="pub-meta">No publications found.</p>';
      return `
        <ul class="pubs">
          ${papers.map(p=>{
            const year = p.year ? ` (${p.year})` : '';
            const venue = p.venue ? ` — <em>${p.venue}</em>` : '';
            const doi = p.externalIds?.DOI ? `https://doi.org/${p.externalIds.DOI}` : null;
            const url = doi || p.url || '#';
            return `
              <li>
                <div class="pub-title"><a href="${url}" target="_blank" rel="noopener">${p.title}</a>${year}${venue}</div>
              </li>`;
          }).join('')}
        </ul>
      `;
    }

    async function loadMember(){
      const id = qs('id');
      const root = document.getElementById('member-article');
      if(!id){ root.innerHTML = '<div class="profile__body"><p>No member specified.</p></div>'; return; }

      let meta = null;
      try {
        const idx = await (await fetch('members/index.json')).json();
        meta = (idx.members || []).find(x => x.id === id) || null;
      } catch {}

      // Build header
      const photo = meta?.photo || 'assets/img/person-placeholder.svg';
      const name = meta?.name || 'Member';
      const role = meta?.role || '';
      const email = meta?.email || '';
      const orcid = meta?.orcid || '';
      const scholarId = meta?.semanticScholarId || '';
      const website = meta?.website || '';
      const scholarUrl = meta?.scholar || (scholarId ? `https://www.semanticscholar.org/author/${encodeURIComponent(scholarId)}` : '');

      const chips = [];
      if (email) chips.push(chip(`${ICONS.email()} ${email}`, `mailto:${email}`, 'chip--accent'));
      if (orcid) chips.push(`<a class="chip chip--orcid" href="https://orcid.org/${orcid}" target="_blank" rel="noopener">${ICONS.orcid()} ${orcid}</a>`);
      if (scholarUrl) chips.push(chip(`Semantic Scholar`, scholarUrl, 'chip--accent'));
      if (website) chips.push(chip(`Website`, website));

      // Load member custom content
      let bodyHTML = '';
      try {
        const res = await fetch(`members/${encodeURIComponent(id)}.html`);
        if (res.ok) bodyHTML = await res.text();
      } catch {}

      // Try Semantic Scholar publications
      let pubsHTML = '';
      if (scholarId){
        try {
          const papers = await fetchSemanticScholarWorks(scholarId, 8);
          pubsHTML = `
            <div class="section">
              <h2 class="section__title">Recent Publications</h2>
              ${renderPubs(papers)}
            </div>`;
        } catch {
          pubsHTML = '<p class="pub-meta">Publications temporarily unavailable.</p>';
        }
      }

      // Compose page
      root.innerHTML = `
        <div class="profile__header">
          <img class="profile__avatar" src="${photo}" alt="${name}">
          <div>
            <h1 class="profile__title">${name}</h1>
            <p class="profile__subtitle">${role}</p>
            <div class="profile__chips">${chips.join('')}</div>
          </div>
        </div>
        <div class="profile__body">
          ${bodyHTML ? `<div class="section">${bodyHTML}</div>` : ''}
          ${pubsHTML}
        </div>
      `;
    }

    document.addEventListener('DOMContentLoaded', loadMember);
  </script>
</body>
</html>
