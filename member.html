<!DOCTYPE html>
<html lang="en">
<head>
  <title>Member — PQuIP Group</title>
</head>
<body>
<div id="site-header"></div>

<main class="container main-content">
  <article id="member-article" class="card"></article>
</main>

<div id="site-footer"></div>

<script src="assets/js/main.js"></script>
<script>
function qs(name){
  try{
    return new URL(window.location.href).searchParams.get(name);
  }catch{ return null; }
}

function orcidIcon(){
  return `
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256" aria-hidden="true">
    <circle cx="128" cy="128" r="120" fill="#A6CE39"/>
    <path fill="#fff" d="M86 88h20v80H86zM96 64a12 12 0 110 24 12 12 0 010-24zm42 24c35 0 54 24 54 60 0 38-21 60-56 60h-26V88h28zm-8 104h6c24 0 36-16 36-44s-12-44-36-44h-6v88z"/>
  </svg>`;
}

function linkPill(href, label){
  return `<a class="pill" href="${href}" target="_blank" rel="noopener">${label}</a>`;
}

async function fetchSemanticScholarWorks(authorId, limit=10){
  const fields = [
    'name',
    'url',
    'papers.title',
    'papers.year',
    'papers.externalIds',
    'papers.authors',
    'papers.venue',
    'papers.url'
  ].join(',');
  const endpoint = `https://api.semanticscholar.org/graph/v1/author/${encodeURIComponent(authorId)}?fields=${fields}`;
  const res = await fetch(endpoint);
  if(!res.ok) throw new Error('Semantic Scholar fetch failed');
  const json = await res.json();
  const papers = (json.papers || [])
    .sort((a,b) => (b.year||0) - (a.year||0))
    .slice(0, limit);
  return { author: json, papers };
}

function renderPubs(papers){
  if(!papers || !papers.length) return '<p>No publications found.</p>';
  return `
    <h2>Recent Publications</h2>
    <ul class="pub-list">
      ${papers.map(p => {
        const year = p.year ? ` (${p.year})` : '';
        const venue = p.venue ? ` — <em>${p.venue}</em>` : '';
        const doi = p.externalIds && p.externalIds.DOI ? p.externalIds.DOI : null;
        const url = doi ? `https://doi.org/${doi}` : (p.url || '#');
        return `<li><strong>${p.title}</strong>${year}${venue}. <a href="${url}" target="_blank" rel="noopener">Link</a></li>`;
      }).join('')}
    </ul>
  `;
}

async function loadMember(){
  const id = qs('id');
  const container = document.getElementById('member-article');
  if(!id){ container.innerHTML = '<p>No member specified.</p>'; return; }

  let meta = null;
  try{
    const idx = await (await fetch('members/index.json')).json();
    meta = (idx.members || []).find(x => x.id === id) || null;
  }catch(e){
    console.error(e);
  }

  // Header (photo, name, role, email, ORCID)
  let headerHTML = '';
  if(meta){
    const orcidLink = meta.orcid ? `https://orcid.org/${meta.orcid}` : null;
    headerHTML = `
      <div class="row" style="margin-bottom:12px;">
        <img src="${meta.photo || 'assets/img/person-placeholder.svg'}" alt="${meta.name}" style="width:100px;height:auto;border-radius:12px;border:1px solid var(--line);background:#f1f3f5;">
        <div style="min-width:220px;">
          <h1 style="margin:0 0 6px">${meta.name}</h1>
          <p style="margin:0;color:var(--muted)">${meta.role || ''}</p>
          ${meta.email ? `<p style="margin:6px 0 0;"><a href="mailto:${meta.email}">${meta.email}</a></p>` : ''}
          <div class="row" style="margin-top:8px;">
            ${orcidLink ? `<span class="pill">${orcidIcon()} <a href="${orcidLink}" style="text-decoration:none" target="_blank" rel="noopener">${meta.orcid}</a></span>` : ''}
            ${meta.semanticScholarId ? linkPill(`https://www.semanticscholar.org/author/${encodeURIComponent(meta.semanticScholarId)}`, "Semantic Scholar") : ''}
          </div>
        </div>
      </div>
      <hr style="border:none;border-top:1px solid var(--line);margin:12px 0 18px;">
    `;
  }

  // Load member's custom HTML
  let bodyHTML = '';
  try{
    const res = await fetch(`members/${encodeURIComponent(id)}.html`);
    if(res.ok) bodyHTML = await res.text();
  }catch(e){
    console.warn('Member content fetch failed:', e);
  }

  // Publications via Semantic Scholar
  let pubsHTML = '';
  if(meta && meta.semanticScholarId){
    try{
      const { papers } = await fetchSemanticScholarWorks(meta.semanticScholarId, 10);
      pubsHTML = renderPubs(papers);
    }catch(e){
      console.warn('Semantic Scholar failed:', e);
      pubsHTML = '<p style="color:var(--muted)">Publications temporarily unavailable.</p>';
    }
  }else{
    pubsHTML = '<p style="color:var(--muted)">Add <code>semanticScholarId</code> in <code>members/index.json</code> to show recent publications automatically.</p>';
  }

  container.innerHTML = headerHTML + bodyHTML + (pubsHTML ? `<div style="margin-top:20px;">${pubsHTML}</div>` : '');
}

loadMember();
</script>
</body>
</html>
